# DirectoryBolt AI Worker - Agents & Architecture Guide

## 📋 Overview

DirectoryBolt is an enterprise AI-powered business directory automation platform ($149-799 pricing tier). The AI Worker backend handles intelligent directory submissions using coordinated AI services (Claude + Gemini), form mapping, success probability prediction, and intelligent retry strategies. This guide maps the complete system architecture for agent-based development workflows.

---

## 🎯 What This Repository Does

**DirectoryBolt** solves the complexity of multi-directory business submissions by automating them with AI intelligence:

- **AIFormMapper**: Intelligently analyzes directory submission forms and maps business data to form fields
- **AI Submission Orchestrator**: Coordinates all AI services to optimize submission success
- **Success Probability Calculator**: Predicts submission success rates before execution
- **Timing Optimizer**: Optimizes when submissions happen for best results
- **Description Customizer**: Tailors business descriptions per directory platform
- **Intelligent Retry Analyzer**: Smart failure recovery with AI-driven retry decisions
- **Queue Management**: Respects pause/resume states with real-time sync to Supabase
- **Health Monitoring**: Regular heartbeats and worker status tracking

### Key Responsibilities

- Real-time form analysis and intelligent field mapping
- Multi-AI service orchestration (Anthropic Claude, Google Gemini)
- Success prediction and optimization
- Queue-based job processing with pause/resume capability
- Playwright-based browser automation
- CAPTCHA solving integration
- Real-time worker health monitoring
- Comprehensive error handling and intelligent retry logic

---

## 🗃️ Architecture Overview

### System Context

```
[Job Queue (Supabase)] → [AI Worker]
         ↓                    ↓
[Pause/Resume Control] → [Form Analysis & Mapping]
         ↓                    ↓
[Playwright Automation] → [AI Services (Claude + Gemini)]
         ↓                    ↓
[Success Prediction] → [CAPTCHA Service]
         ↓                    ↓
[Timing Optimizer] → [Directory Submission]
         ↓                    ↓
[Worker Heartbeat] → [Health Monitoring]
```

### Key Components

| Component | Purpose | AI Service |
|-----------|---------|-----------|
| **AIFormMapper** | Analyzes directory forms, identifies fields, maps business data intelligently | Claude |
| **AI Orchestrator** | Coordinates all AI services, handles errors, manages retries | Orchestrates multiple |
| **Success Calculator** | Predicts submission success based on form complexity and data quality | Claude |
| **Timing Optimizer** | Calculates optimal submission timing to avoid detection/blocking | Claude |
| **Description Customizer** | Generates directory-specific business descriptions | Gemini |
| **Retry Analyzer** | Analyzes failures, determines retry strategy (backoff, remap, manual) | Claude |
| **Playwright Worker** | Browser automation, form filling, submission execution | N/A |
| **Health Monitor** | Tracks worker status, sends heartbeats, monitors AI service health | N/A |

---

## 📁 Project Structure [Complete Directory Tree]

```
DirectoryBolt/
├── workers/
│   └── playwright-worker/                     # AI-Enhanced Playwright Worker
│       ├── src/
│       │   ├── services/                      # Core AI services
│       │   │   ├── ai-form-mapper.ts          # Form analysis & field mapping
│       │   │   ├── ai-submission-orchestrator.ts # AI service coordination
│       │   │   ├── success-calculator.ts      # Success probability prediction
│       │   │   ├── timing-optimizer.ts        # Submission timing optimization
│       │   │   ├── description-customizer.ts  # Directory-specific descriptions
│       │   │   ├── retry-analyzer.ts          # Intelligent retry strategy
│       │   │   ├── captcha-solver.ts          # CAPTCHA handling (2Captcha)
│       │   │   └── queue-manager.ts           # Job queue & pause/resume
│       │   │
│       │   ├── integration/                   # External integrations
│       │   │   ├── anthropic-client.ts        # Claude API integration
│       │   │   ├── gemini-client.ts           # Google Gemini integration
│       │   │   ├── supabase-client.ts         # Supabase DB & heartbeat
│       │   │   ├── playwright-client.ts       # Playwright browser automation
│       │   │   └── two-captcha-client.ts      # CAPTCHA service integration
│       │   │
│       │   ├── models/                        # Data models
│       │   │   ├── Job.ts                     # Job queue schema
│       │   │   ├── FormField.ts               # Form field analysis
│       │   │   ├── SubmissionResult.ts        # Submission outcomes
│       │   │   ├── WorkerHeartbeat.ts         # Worker status tracking
│       │   │   └── AIAnalysis.ts              # AI analysis results
│       │   │
│       │   ├── middleware/                    # Processing middleware
│       │   │   ├── job-validator.ts           # Job input validation
│       │   │   ├── rate-limiter.ts            # API rate limiting
│       │   │   ├── error-handler.ts           # Global error handling
│       │   │   └── auth-validator.ts          # API key validation
│       │   │
│       │   ├── utils/                         # Utility functions
│       │   │   ├── logger.ts                  # Structured logging
│       │   │   ├── retry-strategy.ts          # Exponential backoff
│       │   │   ├── form-parser.ts             # HTML form parsing
│       │   │   ├── data-mapper.ts             # Business data → form mapping
│       │   │   ├── timing-calculator.ts       # Optimal timing logic
│       │   │   └── health-checker.ts          # Service health checks
│       │   │
│       │   ├── jobs/                          # Background job processors
│       │   │   ├── job-processor.ts           # Main job processing loop
│       │   │   ├── heartbeat-sender.ts        # Periodic heartbeat
│       │   │   ├── queue-poller.ts            # Poll for new jobs
│       │   │   └── cleanup-job.ts             # Periodic cleanup
│       │   │
│       │   ├── handlers/                      # Request handlers
│       │   │   ├── health-handler.ts          # Health check endpoint
│       │   │   ├── job-handler.ts             # Job submission handling
│       │   │   └── status-handler.ts          # Status reporting
│       │   │
│       │   ├── types/                         # TypeScript type definitions
│       │   │   ├── job.types.ts               # Job schemas
│       │   │   ├── ai.types.ts                # AI service types
│       │   │   ├── submission.types.ts        # Submission result types
│       │   │   └── error.types.ts             # Error definitions
│       │   │
│       │   ├── config/                        # Configuration
│       │   │   ├── environment.ts             # Env variable setup
│       │   │   ├── ai-config.ts               # AI service configuration
│       │   │   └── retry-config.ts            # Retry strategy config
│       │   │
│       │   ├── worker.ts                      # Worker entry point
│       │   └── index.ts                       # Application bootstrap
│       │
│       ├── Dockerfile                         # Docker container setup
│       ├── package.json                       # Dependencies & scripts
│       └── tsconfig.json                      # TypeScript configuration
│
├── lib/
│   └── ai-services/                           # Shared AI service utilities
│       ├── form-mapper/                       # Form mapping logic
│       ├── submission-orchestrator/           # Orchestration utilities
│       ├── success-calculator/                # Success prediction logic
│       └── retry-analyzer/                    # Retry analysis utilities
│
├── database/
│   └── migrations/                            # Supabase schema migrations
│       ├── system_settings_table.sql          # Queue pause/resume config
│       └── worker_heartbeats_table.sql        # Worker status tracking
│
└── docs/
    ├── AI-WORKER-DEPLOYMENT-GUIDE.md          # Deployment to Render
    └── AI-SERVICES-REFERENCE.md               # AI service documentation
```

---

## 🔧 Technology Stack

### Core Technologies

- **Language**: TypeScript 5.2+ - Full type safety across worker services
- **Runtime**: Node.js 20 - Server runtime for job processing
- **Browser Automation**: Playwright - Form filling and submission
- **Database**: Supabase (PostgreSQL) - Job queue and worker heartbeats
- **AI Services**: Anthropic Claude + Google Gemini - Intelligent form analysis

### Key Libraries

| Library | Purpose |
|---------|---------|
| `@anthropic-ai/sdk` | Claude API for form analysis and intelligence |
| `@google/generative-ai` | Google Gemini for description customization |
| `playwright` | Browser automation for form submission |
| `@supabase/supabase-js` | Database and real-time updates |
| `dotenv` | Environment variable management |
| `axios` | HTTP client for 2Captcha integration |
| `winston` | Structured logging |
| `joi` | Schema validation |

### Development Tools

- **Testing**: Jest - Unit and integration tests
- **Linting**: ESLint - Code quality enforcement
- **Type Checking**: TypeScript strict mode
- **Container**: Docker - Render.com deployment
- **Process Manager**: PM2 (optional local development)

---

## 🌐 External Dependencies

### Required Services

| Service | Purpose | Environment Variable |
|---------|---------|---------------------|
| **Anthropic Claude** | Form analysis, success prediction, retry logic | `ANTHROPIC_API_KEY` |
| **Google Gemini** | Business description customization | `GEMINI_API_KEY` |
| **Supabase** | Job queue, worker heartbeats, system settings | `SUPABASE_URL`, `SUPABASE_SERVICE_ROLE_KEY` |
| **2Captcha** | CAPTCHA solving service | `TWO_CAPTCHA_API_KEY` |
| **Netlify Functions** | Job polling endpoint | `NETLIFY_FUNCTIONS_URL`, `AUTOBOLT_API_KEY` |

### Environment Variables

```bash
# Basic Configuration
NODE_ENV=production
PORT=3000
POLL_INTERVAL=5000                    # Poll every 5 seconds
WORKER_ID=ai-enhanced-worker-1        # Unique worker identifier

# API Configuration - REQUIRED
AUTOBOLT_API_KEY=<api_key>            # Netlify API authentication
AUTOBOLT_API_BASE=https://directorybolt.netlify.app
NETLIFY_FUNCTIONS_URL=https://directorybolt.netlify.app
WORKER_AUTH_TOKEN=<token>             # Worker authentication

# Playwright Configuration
PLAYWRIGHT_HEADLESS=true              # Headless browser mode
PLAYWRIGHT_TIMEOUT=30000              # 30 second timeout
HEADLESS=true

# AI Services - REQUIRED for full functionality
ANTHROPIC_API_KEY=<claude_api_key>    # Anthropic Claude API key
GEMINI_API_KEY=<gemini_api_key>       # Google Gemini API key

# CAPTCHA Service
TWO_CAPTCHA_API_KEY=<captcha_key>    # 2Captcha service API key

# Database Configuration - REQUIRED
SUPABASE_URL=<your_supabase_url>
SUPABASE_SERVICE_ROLE_KEY=<service_role_key>  # NOT the anon key!

# Logging
LOG_LEVEL=info                         # info, debug, error, warn
```

---

## 📊 Common Workflows

### AI Form Analysis Workflow

1. Job received from queue
2. **AIFormMapper** analyzes directory form HTML with Claude
3. Form fields identified and mapped to business data
4. Confidence scores calculated for each mapping
5. Form filling strategy determined (field order, special handling)
6. Success probability estimated
7. Optimal timing calculated
8. Business description customized for directory platform

**Code path**: `workers/playwright-worker/src/jobs/job-processor.ts` → `services/ai-form-mapper.ts` → `integration/anthropic-client.ts` → `services/ai-submission-orchestrator.ts`

### Directory Submission Workflow

1. Queue manager checks if queue is paused (Supabase)
2. Poll Netlify API for next job
3. AIFormMapper analyzes the directory form
4. Success probability calculated
5. If success probability > threshold:
   - Timing optimizer calculates delay
   - Playwright navigates to directory
   - Forms filled intelligently using AI analysis
   - CAPTCHA solved if encountered
   - Submission executed
6. Result captured and logged
7. Worker status updated in heartbeat
8. On failure, retry analyzer determines strategy

**Code path**: `workers/playwright-worker/src/jobs/queue-poller.ts` → `services/ai-submission-orchestrator.ts` → `integration/playwright-client.ts` → `services/retry-analyzer.ts`

### Queue Pause/Resume Workflow

1. Staff updates `system_settings` table in Supabase
2. Worker checks pause state on each polling cycle
3. If paused: Worker sleeps and retries at interval
4. If resumed: Worker continues processing
5. Pause state logged for audit trail
6. Staff dashboard shows real-time pause status

**Code path**: `services/queue-manager.ts` → `integration/supabase-client.ts` → `jobs/queue-poller.ts`

### Intelligent Retry Workflow

1. Submission fails with specific error
2. **Retry Analyzer** examines failure type:
   - **Temporary** (timeout, rate limit): Exponential backoff
   - **Form Issue** (unmapped fields): Re-analyze with Claude
   - **CAPTCHA Fail** (multiple attempts): Try 2Captcha again
   - **Permanent** (invalid data, duplicate): Mark as failed
3. Retry strategy determined and logged
4. Job re-queued or escalated for manual review
5. Staff notified of failed submissions

**Code path**: `services/retry-analyzer.ts` → `integration/anthropic-client.ts` → `services/ai-submission-orchestrator.ts`

### Worker Health Monitoring

1. Worker starts and initializes AI services
2. Periodic heartbeat job runs every 60 seconds
3. Heartbeat includes:
   - Worker ID and status
   - Last job processed
   - AI services health status
   - Jobs processed count
   - Memory usage
4. Heartbeat sent to Supabase `worker_heartbeats` table
5. Dashboard queries heartbeats to show worker status
6. Missing heartbeat triggers alert (worker down)

**Code path**: `jobs/heartbeat-sender.ts` → `integration/supabase-client.ts` → Dashboard queries

---

## 📄 File Navigation Guide

| File | Purpose | When You'd Touch It |
|------|---------|-------------------|
| `services/ai-form-mapper.ts` | Form analysis & field mapping | Improving form recognition accuracy |
| `services/ai-submission-orchestrator.ts` | AI service coordination | Adding new AI services or workflows |
| `services/success-calculator.ts` | Success probability | Adjusting success thresholds |
| `services/timing-optimizer.ts` | Submission timing | Optimizing timing strategy |
| `services/description-customizer.ts` | Directory-specific descriptions | Improving descriptions per platform |
| `services/retry-analyzer.ts` | Intelligent retry logic | Changing retry strategies |
| `services/queue-manager.ts` | Queue pause/resume control | Queue management changes |
| `integration/anthropic-client.ts` | Claude API integration | Claude service updates |
| `integration/playwright-client.ts` | Browser automation | Form filling logic changes |
| `jobs/job-processor.ts` | Main processing loop | Workflow changes |
| `jobs/queue-poller.ts` | Job polling from Netlify | Polling strategy changes |
| `models/Job.ts` | Job queue schema | Job data structure changes |
| `types/ai.types.ts` | AI service type definitions | API contract changes |
| `worker.ts` | Worker entry point | Bootstrap configuration |

---

## 🚀 Development Workflows (ACE-FCA)

### Stage-Based Development System

The AI Worker uses ACE-FCA (Agentic Code Exploration - Form Code Audit) with stages:

#### Stage 1: Form Analysis Enhancement
- Improve AIFormMapper accuracy
- Add new form type detection
- Enhance field mapping logic

#### Stage 2: AI Service Integration
- Add new AI services (Ollama, local models)
- Optimize prompt engineering
- Enhance context window usage

#### Stage 3: Retry & Recovery
- Improve retry analyzer logic
- Add fallback strategies
- Enhance error classification

#### Stage 4: Performance & Optimization
- Optimize playwright speed
- Reduce API latency
- Improve success rates

### Using Agents for Development

```json
{
  "function": "stage2AIServiceIntegration",
  "arguments": {
    "services": ["anthropic-client.ts", "gemini-client.ts"],
    "focus": ["prompt optimization", "error handling", "cost management"]
  }
}
```

**Use Sam (Project Planner)** to:
- Break down feature development
- Identify dependencies
- Plan integration phases
- Estimate timelines

**Use Shane (Backend Developer)** to:
- Design API contracts
- Optimize database queries
- Implement retry logic
- Handle error scenarios

**Use Hudson (Code Reviewer)** to:
- Review AI service integrations
- Audit error handling
- Validate type safety
- Check security compliance

---

## 🔒 Security Considerations

### API Security
- **API Key Validation**: All requests require `AUTOBOLT_API_KEY` or `WORKER_AUTH_TOKEN`
- **Rate Limiting**: Prevent abuse of Anthropic/Gemini APIs
- **Error Messages**: No sensitive data in error responses

### Data Protection
- **Form Data**: Never log sensitive user information
- **AI Service Keys**: Stored in environment variables only
- **Supabase Auth**: Use `SERVICE_ROLE_KEY` for worker access (not anon key)

### CAPTCHA Handling
- **Safe Service**: 2Captcha integrated for human verification
- **Fallback**: Manual review if CAPTCHA fails multiple times
- **Rate Limiting**: Throttle CAPTCHA attempts to prevent abuse

### Webhook Validation
- **Netlify Webhooks**: Validate webhook signatures
- **Supabase Realtime**: Validate connection tokens
- **Error Escalation**: Manual review for suspicious patterns

---

## 📊 Data Integrations

### Supabase Integration

```sql
-- Job Queue Table
CREATE TABLE IF NOT EXISTS jobs (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  customer_id TEXT NOT NULL,
  directory_name TEXT NOT NULL,
  form_data JSONB NOT NULL,
  status TEXT DEFAULT 'pending',
  ai_analysis JSONB,
  success_probability FLOAT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- System Settings (Queue Pause)
CREATE TABLE IF NOT EXISTS system_settings (
  key TEXT PRIMARY KEY,
  value JSONB,
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Worker Heartbeats
CREATE TABLE IF NOT EXISTS worker_heartbeats (
  worker_id TEXT PRIMARY KEY,
  status TEXT NOT NULL,
  ai_services_enabled BOOLEAN,
  jobs_processed INTEGER,
  last_seen TIMESTAMPTZ,
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### Netlify API Integration

```bash
# Endpoint: GET /api/autobolt/jobs/next
# Fetches next job from queue
# Headers: Authorization: Bearer AUTOBOLT_API_KEY

# Response:
{
  "job_id": "uuid",
  "customer_id": "DIR-2025-XXXXXX",
  "directory": "google_business_profile",
  "form_data": { ... },
  "priority": 1
}
```

---

## 🎯 Success Metrics

### Key Performance Indicators

| Metric | Target | Notes |
|--------|--------|-------|
| **Form Mapping Accuracy** | >95% | AI Form Mapper success rate |
| **Submission Success Rate** | >80% | Successful directory submissions |
| **Average Processing Time** | <5 min | Per directory submission |
| **Worker Uptime** | >99.5% | System availability |
| **AI Service Latency** | <2 sec | Claude + Gemini response time |
| **Queue Processing Time** | <1 min | Job pickup to completion |
| **CAPTCHA Success Rate** | >90% | 2Captcha solving accuracy |

### Monitoring & Alerts

- **Worker Health**: Heartbeat missing >2 minutes → Alert
- **Form Mapping**: Success rate <90% → Alert
- **AI Service Errors**: >5 consecutive failures → Alert
- **Queue Backlog**: >100 pending jobs → Alert
- **Submission Failures**: >10 consecutive failures → Escalate to manual review

---

## 🛠️ Deployment & Operations

### Local Development

```bash
# Install dependencies
npm install

# Set environment variables
cp .env.example .env
# Edit .env with your API keys

# Run locally with monitoring
npm run dev

# Run tests
npm run test

# Type checking
npm run typecheck

# Linting
npm run lint
```

### Deployment to Render.com

```bash
# 1. Create new Web Service on Render
# 2. Connect GitHub repo: Rainking6693/DirectoryBolt
# 3. Configure:
#    - Environment: Docker
#    - Dockerfile Path: ./workers/playwright-worker/Dockerfile
#    - Branch: main

# 4. Set environment variables in Render dashboard
# 5. Deploy

# Verify deployment:
curl https://your-render-url.onrender.com/health
```

### Health Check Response

```json
{
  "status": "healthy",
  "service": "ai-enhanced-playwright-worker",
  "timestamp": "2025-10-21T14:30:00Z",
  "aiServices": "enabled",
  "jobsProcessed": 42,
  "workerUptime": 3600
}
```

---

## 🚨 Things to Be Careful About

### ⚠️ AI Service Costs
- **Claude API**: Monitor token usage, implement caching for repeated forms
- **Gemini API**: Set quota limits to prevent runaway costs
- **Rate Limits**: Implement exponential backoff for API rate limits

### 🎯 Form Mapping Accuracy
- **Field Confidence**: Only fill fields with >80% confidence
- **Validation**: Pre-validate data before submission
- **Error Handling**: Log ambiguous field mappings for manual review
- **Platform Variations**: Different directories have different form structures

### 🔄 Retry Strategy
- **Backoff Logic**: Exponential backoff prevents API throttling
- **Max Retries**: Cap retries at 3 to avoid infinite loops
- **Manual Review**: Escalate after auto-retry fails
- **Timing Optimizer**: Space out retries to avoid detection

### 📊 Queue Management
- **Pause State**: Check frequently; update heartbeat timestamp
- **Job Ordering**: Respect priority field
- **Stale Jobs**: Remove jobs older than 7 days
- **Dead Letter Queue**: Failed jobs go to manual review

### 🔐 Security Best Practices
- **Never log API keys** in error messages
- **Validate all inputs** before AI processing
- **Sanitize HTML** from form analysis
- **Rotate API keys** every 90 days
- **Monitor for suspicious patterns** (too many failures)

---

## ✅ Deployment Checklist

- [ ] All environment variables configured
- [ ] Supabase tables created (jobs, system_settings, worker_heartbeats)
- [ ] Anthropic and Gemini API keys validated
- [ ] 2Captcha account funded and configured
- [ ] Netlify functions endpoint accessible
- [ ] Docker build succeeds without errors
- [ ] Health check endpoint returns 200 OK
- [ ] Worker heartbeat visible in Supabase
- [ ] Queue pause/resume working
- [ ] Test job processes successfully
- [ ] AI services logs show form analysis
- [ ] No errors in Render deployment logs
- [ ] Production API keys set correctly
- [ ] Database backups configured
- [ ] Monitoring and alerts enabled

---

## 📚 Related Documentation

- **[AI Worker Deployment Guide](./AI-WORKER-DEPLOYMENT-GUIDE.md)** - Complete Render deployment instructions
- **[AI Services Reference](./AI-SERVICES-REFERENCE.md)** - Detailed AI integration docs
- **[DirectoryBolt Architecture](./TECHNICAL_ARCHITECTURE.md)** - System design documentation

---

**Version**: 2.0.0 AI-Enhanced  
**Last Updated**: 2025-10-21  
**Status**: Production Ready ✅  
**Deployment**: Render.com Docker Container
