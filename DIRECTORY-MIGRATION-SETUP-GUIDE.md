# 🚀 DirectoryBolt Database Schema Setup Guide

## Quick Start - Ready to Import 484 Directories

This guide will help you set up the correct database schema for importing 484 directories from your Excel file. Follow these steps in order:

### ⚡ 1. Prerequisites Check

```bash
# Ensure environment variables are set
echo $SUPABASE_URL
echo $SUPABASE_SERVICE_ROLE_KEY

# If empty, check your .env.local file
cat .env.local | grep SUPABASE
```

### 🔧 2. Run Database Migration

```bash
# First, do a dry run to see what will happen
npm run migrate:dry-run

# If dry run looks good, run the actual migration
npm run migrate
```

**What this does:**
- Drops any existing `directories` table
- Creates new Excel-compatible `directories` table
- Sets up all required columns matching your Excel import script
- Creates indexes for performance
- Adds constraints for data integrity

### ✅ 3. Validate Schema

```bash
# Validate that schema is correctly set up
npm run validate:schema:verbose
```

**This checks:**
- Database connectivity
- Table existence and structure  
- Column types and constraints
- Required indexes
- Excel import compatibility

### 📊 4. Import Your Excel Data

```bash
# First validate your Excel data
npm run import:excel:validate

# Do a dry run to see what would be imported
npm run import:excel:dry-run

# Import the 484 directories
npm run import:excel
```

## 📋 Complete Command Reference

### Database Migration Commands

```bash
# Run migration (creates Excel-compatible schema)
npm run migrate

# See what migration would do without executing
npm run migrate:dry-run

# Rollback (remove directories table)
npm run migrate:rollback

# Show migration help
npm run migrate:help
```

### Schema Validation Commands

```bash
# Basic schema validation
npm run validate:schema

# Detailed validation with verbose output  
npm run validate:schema:verbose

# Show validation help
npm run validate:schema:help
```

### Excel Import Commands

```bash
# Import directories from Excel
npm run import:excel

# Validate Excel data without importing
npm run import:excel:validate

# Dry run to see what would be imported
npm run import:excel:dry-run

# Show import help and options
npm run import:excel:help
```

## 🎯 Expected Results

After running the migration and validation:

✅ **Database Schema Ready**
- `directories` table created with 20 columns
- All required indexes for performance
- Data constraints for integrity
- Excel import compatibility verified

✅ **Ready for Excel Import**  
- Table structure matches import script expectations
- Category field accepts text values (no foreign key dependency)
- All columns have proper types and constraints
- Performance optimized for 484 directory batch import

## 🔍 Schema Details

The created `directories` table includes:

### Core Fields (from Excel)
- `id` - UUID primary key (auto-generated)
- `name` - Directory name (required, from Excel "Name" column)
- `website` - Website URL (required, unique, from Excel "Website" column) 
- `category` - Category text (required, from Excel "Category" column)
- `domain_authority` - DA score 0-100 (from Excel "DA" column, defaults to 50)

### Enhanced Fields (auto-generated by import script)
- `impact_level` - Low/Medium/High (based on DA)
- `tier_required` - 1-4 (based on DA: 90+=Tier 1, 70-89=Tier 2, etc.)
- `difficulty` - Easy/Medium/Hard (based on DA and pricing)
- `submission_url` - Auto-generated submission URL
- `estimated_traffic` - Calculated from DA
- `time_to_approval` - Based on difficulty
- `price` - In cents (0 for free directories)
- `features` - JSONB array of directory features
- `active` - Boolean (default true)
- `requires_approval` - Boolean (based on difficulty)
- `country_code` - Country code (optional)
- `language` - Default 'en'
- `description` - Directory description (optional)

### Timestamps
- `created_at` - Auto-generated
- `updated_at` - Auto-updated on changes

## 🚨 Troubleshooting

### Migration Fails
```bash
# Check database connection
npm run validate:schema

# Check environment variables  
echo $SUPABASE_URL
echo $SUPABASE_SERVICE_ROLE_KEY

# Try dry run first
npm run migrate:dry-run
```

### Schema Validation Fails
```bash
# Get detailed error information
npm run validate:schema:verbose

# Check if table exists manually
# (Log into Supabase dashboard and check tables)
```

### Excel Import Fails
```bash
# Validate Excel file first
npm run import:excel:validate

# Check schema compatibility
npm run validate:schema

# Try with smaller batch size
node scripts/import-excel-directories.js --batch-size=10
```

## 📁 File Structure

```
migrations/
├── 007_create_excel_compatible_directories_table.sql  # Schema definition
scripts/
├── run-database-migration.js                         # Migration runner
├── validate-database-schema.js                       # Schema validator  
├── import-excel-directories.js                       # Excel importer
```

## 🔄 Development Workflow

1. **Setup Schema**: `npm run migrate`
2. **Validate Setup**: `npm run validate:schema`
3. **Import Data**: `npm run import:excel`
4. **Verify Import**: Check Supabase dashboard or run queries

## 📞 Support

If you encounter issues:

1. **Check Environment**: Ensure `.env.local` has correct Supabase credentials
2. **Validate Schema**: Run `npm run validate:schema:verbose` for diagnostics
3. **Check Logs**: Scripts provide detailed error messages and suggestions
4. **Dry Run First**: Always test with `--dry-run` flags before live operations

## 🎉 Success Indicators

You'll know everything is working when:

✅ Migration completes without errors  
✅ Schema validation shows "READY TO IMPORT"  
✅ Excel validation finds 470+ valid directories  
✅ Import completes with ~484 directories inserted  
✅ Supabase dashboard shows populated directories table

---

**Ready to set up your database for the 484 directory import?**

```bash
# Run these three commands in sequence:
npm run migrate
npm run validate:schema
npm run import:excel
```