<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Worker Status</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: sans-serif; background-color: #f4f4f9; color: #333; }
    #status-container { max-width: 800px; margin: 40px auto; padding: 20px; background: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .worker { border-bottom: 1px solid #eee; padding: 15px 0; }
    .worker:last-child { border-bottom: none; }
    .worker-id { font-weight: bold; color: #555; }
    .status { padding: 5px 10px; border-radius: 15px; color: #fff; font-size: 0.9em; }
    .status-running { background-color: #28a745; }
    .status-idle { background-color: #ffc107; color: #333; }
    .status-error { background-color: #dc3545; }
    .status-paused { background-color: #6c757d; }
    .status-starting { background-color: #17a2b8; }
    button { padding: 8px 12px; border: none; border-radius: 5px; cursor: pointer; margin-left: 10px; }
    .pause-btn { background-color: #ffc107; }
    .resume-btn { background-color: #28a745; color: #fff; }
  </style>
</head>
<body>

  <div id="status-container">
    <h1>Worker Status Dashboard</h1>
    <div id="workers"></div>
  </div>

  <script>
    const SUPABASE_URL = 'https://kolgqfjgncdwddziqloz.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_g9QLk_pzGSTG64PZz-ihPg_9nFcD7sp';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const workersContainer = document.getElementById('workers');

    async function fetchWorkerStatus() {
      const { data, error } = await supabase.from('worker_status').select('*');
      if (error) {
        workersContainer.innerHTML = `<p style="color: red;">Error fetching status: ${error.message}</p>`;
        return;
      }

      if (!data || data.length === 0) {
        workersContainer.innerHTML = '<p>No worker data found.</p>';
        return;
      }

      workersContainer.innerHTML = ''; // Clear previous entries
      data.forEach(worker => {
        const workerDiv = document.createElement('div');
        workerDiv.className = 'worker';

        const statusClass = `status-${worker.status.toLowerCase()}`;
        const desiredState = worker.desired_state;

        workerDiv.innerHTML = `
          <div>
            <span class="worker-id">${worker.worker_id}</span>
            <span class="status ${statusClass}">${worker.status}</span>
            <button class="${desiredState === 'paused' ? 'resume-btn' : 'pause-btn'}" onclick="togglePause('${worker.worker_id}', '${desiredState}')">
              ${desiredState === 'paused' ? 'Resume' : 'Pause'}
            </button>
          </div>
          <small>Last Heartbeat: ${new Date(worker.last_heartbeat).toLocaleString()}</small><br>
          <small>Desired State: ${desiredState}</small>
        `;
        workersContainer.appendChild(workerDiv);
      });
    }

    async function togglePause(workerId, currentState) {
      const newState = currentState === 'paused' ? 'running' : 'paused';
      const { error } = await supabase
        .from('worker_status')
        .update({ desired_state: newState })
        .eq('worker_id', workerId);

      if (error) {
        alert(`Error updating state: ${error.message}`);
      } else {
        fetchWorkerStatus(); // Refresh immediately
      }
    }

    // Fetch status on initial load and then every 5 seconds
    fetchWorkerStatus();
    setInterval(fetchWorkerStatus, 5000);
  </script>

</body>
</html>
